from django.test import TestCase
from django.contrib.auth.models import User
from voyage.models import CritereVoyage, Ville, Pays
from django.urls import reverse
from datetime import date, timedelta
import random
import string

class TestPlanVoyage(TestCase): 

    @classmethod
    def setUpTestData(cls):
        cls.user = User.objects.create_user(username='user_' + cls._random_string(5), password='testpass')
        cls.pays = Pays.objects.create(nom='Pays_' + cls._random_string(4))
        cls.ville = Ville.objects.create(nom='Ville_' + cls._random_string(4), pays=cls.pays)

        today = date.today()
        date_depart = today + timedelta(days=random.randint(1, 30))
        date_retour = date_depart + timedelta(days=random.randint(3, 10))

        cls.critere = CritereVoyage.objects.create(
            utilisateur=cls.user,
            adresse="Rue " + cls._random_string(6),
            date_depart=date_depart,
            date_retour=date_retour,
            budget_total=random.randint(1000, 5000),
            type_voyage=random.choice(["Détente", "Culture", "Aventure"]),
            voyageurs_enfant=random.randint(0, 3),
            voyageurs_jeune=random.randint(0, 2),
            voyageurs_adulte=random.randint(1, 4),
            voyageurs_senior=random.randint(0, 2),
            api_choisie="deepseek"
        )
        cls.critere.ville_destination.add(cls.ville)
        cls.critere.pays_arrivee.add(cls.pays)

    @staticmethod
    def _random_string(length):
        return ''.join(random.choices(string.ascii_letters, k=length))

    def test_plan_voyage_view_returns_200(self):
        url = reverse('plan_travel', args=[self.critere.id])
        self.client.force_login(self.user)
        response = self.client.get(url)
        self.assertEqual(response.status_code, 200)
        
        # Vérifie que le contenu contient une chaîne attendue (optionnel)
        self.assertIn("Plan", response.content.decode())  # adapte selon ta vue

        # print retiré (nettoyage du code)
